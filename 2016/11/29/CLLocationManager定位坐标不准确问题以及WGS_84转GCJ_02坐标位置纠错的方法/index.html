<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="iOSのcoder">
    

    <!--Author-->
    
        <meta name="author" content="John">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="CLLocationManager定位坐标不准确问题以及WGS_84转GCJ_02坐标位置纠错的方法"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="iOSのcoder" />
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Roach"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>CLLocationManager定位坐标不准确问题以及WGS_84转GCJ_02坐标位置纠错的方法 - Roach</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about.html">
                    About
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact.html">
                    Contact
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2016/11/29/CLLocationManager定位坐标不准确问题以及WGS_84转GCJ_02坐标位置纠错的方法/">
                CLLocationManager定位坐标不准确问题以及WGS_84转GCJ_02坐标位置纠错的方法
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2016-11-29</span>
            
            <a href="#disqus_thread" class="comments">Comments</a>
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <h2 id="背景："><a href="#背景：" class="headerlink" title="背景："></a>背景：</h2><p>  最近用高德的一个基于web的URI地图路径规划及导航模块，以实现根据起始坐标 实现路径规划，<a href="http://lbs.amap.com/api/uri-api/guide/mobile-web/route-plan/" target="_blank" rel="external">见此处</a>  </p>
<p>  起点是当前位置，由于没有集成高德API，所以用系统的CLLocationManager实现定位。</p>
<h2 id="问题："><a href="#问题：" class="headerlink" title="问题："></a>问题：</h2><p>  但是实际上，CLLocationManager定位的坐标，在高德地图上标注的位置与实际地点有偏差，并且较大！以前知道不同的地图坐标不能直接通用，但是如我所知，Apple的地图也是基于高德的，为什么CLLocationManager定位出的不准确，而MKMapView的定位却是准确的呢？</p>
<h2 id="原因："><a href="#原因：" class="headerlink" title="原因："></a>原因：</h2><p>  是这样的，按照国家统一的保密要求，任何一个地图产品都不允许使用GPS坐标，国内地图使用的坐标系统是<font color="green">GCJ-02</font>。<font size="2" color="blue">GCJ-02，国测局02年发布的坐标体系。又称“火星坐标”。</font>在中国，必须<font color="red">至少使用</font>GCJ-02的坐标体系。比如<font color="red">谷歌</font>，<font color="red">腾讯</font>，<font color="red">高德</font>都在用这个坐标体系。<br>  国内其他坐标体系。一般都是由GCJ-02进过偏移算法得到的。这种体系就根据每个公司的不同，坐标体系都不一样了。比如，<font color="red">百度和搜狗</font>就使用自己的坐标体系，与其他坐标体系不兼容。百度（BD_09坐标）<br>  到这里大家可能都猜出了CLLocationManager有偏差，是因为采用的是<font color="brown">WGS-84</font>，也就是GPS原始坐标；<br>  Apple的MKMapView框架准确，是因为 老乔想进中国，就得按规矩来咯，所以iOS中的地图理所应当将<font color="brown">WGS-84</font>坐标转成了国内<font color="green">GCJ-02</font>坐标;</p>
<h2 id="解决："><a href="#解决：" class="headerlink" title="解决："></a>解决：</h2><h3 id="思路一："><a href="#思路一：" class="headerlink" title="思路一："></a>思路一：</h3><p>  使用现有API转换，将CLLocationManager的WGS_84坐标转成GCJ_02坐标，调用apple的私有模块类<font color="brown">MKLocationManager</font>中得方法来对经纬度做一个偏移修正</p>
<p><font color="red">问题：但是如此使用会审核被拒，而且iOS 5之后，这个方法已经不再使用。</font></p>
<h3 id="思路二："><a href="#思路二：" class="headerlink" title="思路二："></a>思路二：</h3><p>  既然MKMapView地图中的定位是准确的，那么用[self.mapView setShowsUserLocation:YES]得了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">-(void)mapView:(MKMapView *)mapView didUpdateUserLocation:(MKUserLocation *)userLocation &#123;</div><div class="line">  CLLocationCoordinate2D coord = [userLocation coordinate];</div><div class="line">  NSLog(@&quot;经度:%f,纬度:%f&quot;,coord.latitude,coord.longitude);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><font color="red">不足：需要将mapView加到父视图上，不然不会调用上面的代理方法，当然了，可以设置为hidden=YES，也是个办法</font></p>
<h3 id="思路三："><a href="#思路三：" class="headerlink" title="思路三："></a>思路三：</h3><p>  使用算法，对得到的WGS_84坐标处理，得到GCJ_02坐标</p>
<p><font size="2" color="grag">听闻是为了国家安全搞的加密措施，使用的是非线性的偏移值，想得到真实的数据，得同GCJ申请，交钱，才能得到解密方法。不过高手在民间啊，被人破解了,具体<a href="https://wuyongzheng.wordpress.com/2010/01/22/china-map-deviation-as-a-regression-problem/" target="_blank" rel="external">算法分析可以看这篇文章</a></font></p>
<p><font color="red">这个算法网上是有的，具体出自谁不清楚，还是要感谢并参考一下，下面贴出位置纠错算法的OC代码：新建一个继承NSObject的类</font></p><br>WGS84ConvertToGCJ02.h 文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">#import &lt;Foundation/Foundation.h&gt;</div><div class="line">#import &lt;MapKit/MapKit.h&gt;</div><div class="line"></div><div class="line">@interface WGS84ConvertToGCJ02ForAMapView : NSObject</div><div class="line">//判断是否已经超出中国范围</div><div class="line">+(BOOL)isLocationOutOfChina:(CLLocationCoordinate2D)location;</div><div class="line">//转GCJ-02</div><div class="line">+(CLLocationCoordinate2D)transformFromWGSToGCJ:(CLLocationCoordinate2D)wgsLoc;</div><div class="line">@end</div></pre></td></tr></table></figure><br><br>WGS84ConvertToGCJ02.m文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">#import &quot;WGS84ConvertToGCJ02ForAMapView.h&quot;</div><div class="line"></div><div class="line">const double a = 6378245.0;</div><div class="line">const double ee = 0.00669342162296594323;</div><div class="line"></div><div class="line">@implementation WGS84ConvertToGCJ02ForAMapView</div><div class="line"></div><div class="line">+(CLLocationCoordinate2D)transformFromWGSToGCJ:(CLLocationCoordinate2D)wgsLoc</div><div class="line">&#123;</div><div class="line">  CLLocationCoordinate2D adjustLoc;</div><div class="line">  if([self isLocationOutOfChina:wgsLoc])&#123;</div><div class="line">    adjustLoc = wgsLoc;</div><div class="line">  &#125;else&#123;</div><div class="line">    double adjustLat = [self transformLatWithX:wgsLoc.longitude - 105.0 withY:wgsLoc.latitude - 35.0];</div><div class="line">    double adjustLon = [self transformLonWithX:wgsLoc.longitude - 105.0 withY:wgsLoc.latitude - 35.0];</div><div class="line">    double radLat = wgsLoc.latitude / 180.0 * M_PI;</div><div class="line">    double magic = sin(radLat);</div><div class="line">    magic = 1 - ee * magic * magic;</div><div class="line">    double sqrtMagic = sqrt(magic);</div><div class="line">    adjustLat = (adjustLat * 180.0) / ((a * (1 - ee)) / (magic * sqrtMagic) * M_PI);</div><div class="line">    adjustLon = (adjustLon * 180.0) / (a / sqrtMagic * cos(radLat) * M_PI);</div><div class="line">    adjustLoc.latitude = wgsLoc.latitude + adjustLat - 0.00039900; // 减去这个数字 完全是凑数，准确性有待验证</div><div class="line">    adjustLoc.longitude = wgsLoc.longitude + adjustLon;</div><div class="line">  &#125;</div><div class="line">  return adjustLoc;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//判断是不是在中国</div><div class="line">+(BOOL)isLocationOutOfChina:(CLLocationCoordinate2D)location</div><div class="line">&#123;</div><div class="line">  if (location.longitude &lt; 72.004 || location.longitude &gt; 137.8347 || location.latitude &lt; 0.8293 || location.latitude &gt; 55.8271)</div><div class="line">    return YES;</div><div class="line">  return NO;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+(double)transformLatWithX:(double)x withY:(double)y</div><div class="line">&#123;</div><div class="line">  double lat = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * sqrt(fabs(x));</div><div class="line">  lat += (20.0 * sin(6.0 * x * M_PI) + 20.0 *sin(2.0 * x * M_PI)) * 2.0 / 3.0;</div><div class="line">  lat += (20.0 * sin(y * M_PI) + 40.0 * sin(y / 3.0 * M_PI)) * 2.0 / 3.0;</div><div class="line">  lat += (160.0 * sin(y / 12.0 * M_PI) + 320 * sin(y * M_PI / 30.0)) * 2.0 / 3.0;</div><div class="line">  return lat;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+(double)transformLonWithX:(double)x withY:(double)y</div><div class="line">&#123;</div><div class="line">  double lon = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * sqrt(fabs(x));</div><div class="line">  lon += (20.0 * sin(6.0 * x * M_PI) + 20.0 * sin(2.0 * x * M_PI)) * 2.0 / 3.0;</div><div class="line">  lon += (20.0 * sin(x * M_PI) + 40.0 * sin(x / 3.0 * M_PI)) * 2.0 / 3.0;</div><div class="line">  lon += (150.0 * sin(x / 12.0 * M_PI) + 300.0 * sin(x / 30.0 * M_PI)) * 2.0 / 3.0;</div><div class="line">  return lon;</div><div class="line">&#125;</div><div class="line">@end</div></pre></td></tr></table></figure><br><br><p>以我的项目为例，在CLLocationManager的定位代理方法中这样使用：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">#pragma mark -</div><div class="line">#pragma mark CLLocationManagerDelegate</div><div class="line">- (void)locationManager:(CLLocationManager *)manager</div><div class="line">     didUpdateLocations:(NSArray *)locations</div><div class="line">&#123;</div><div class="line">  CLLocation *newLocation = [locations firstObject];</div><div class="line">  //判断是不是属于国内范围</div><div class="line">  if (![WGS84ConvertToGCJ02ForAMapView isLocationOutOfChina:[newLocation coordinate]]) &#123;</div><div class="line">    //转换后的coord</div><div class="line">    CLLocationCoordinate2D coord = [WGS84ConvertToGCJ02ForAMapView transformFromWGSToGCJ:[newLocation coordinate]];</div><div class="line">    newLocation = [[CLLocation alloc] initWithLatitude:coord.latitude longitude:coord.longitude];</div><div class="line">  &#125;</div><div class="line">  if (_location) &#123;</div><div class="line">    if (newLocation.horizontalAccuracy &lt; _location.horizontalAccuracy) &#123;</div><div class="line">      _location = newLocation;</div><div class="line">      [self postLocationNotificationOnMainThreadWithName:GPSManagerUpdateLocationNotification];</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  else&#123;</div><div class="line">    _location = newLocation;</div><div class="line">    [self postLocationNotificationOnMainThreadWithName:GPSManagerUpdateLocationNotification];</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><font color="red">不足：毕竟不是正统解密算法，还是会有偏差，大概10+m，但是精度已经很高了。</font></p>

<h2 id="位置纠错算法的OC代码源文件"><a href="#位置纠错算法的OC代码源文件" class="headerlink" title="位置纠错算法的OC代码源文件"></a>位置纠错算法的OC代码源文件</h2><p><a href="https://github.com/jakajacky/WGS84--GCJ02" target="_blank" rel="external">下载地址</a></p>

    </div>

    

    
        <div class="post-tags">
            <i class="fa fa-tags" aria-hidden="true"></i>
            <a href="/tags/iOS/">#iOS</a> <a href="/tags/位置纠错算法/">#位置纠错算法</a>
        </div>
    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>

</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    This theme was developed by <a href="https://github.com/klugjo">Jonathan Klughertz</a>. The source code is available on Github. Create Websites. Make Magic.
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2016/11/29/CLLocationManager定位坐标不准确问题以及WGS_84转GCJ_02坐标位置纠错的方法/">CLLocationManager定位坐标不准确问</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2016/11/23/iOS应用之间跳转 报错：_This app is not allowed to query for scheme ____/">iOS应用之间跳转 报错：This app is </a>
            </li>
            
            <li>
                <a class="footer-post" href="/2016/11/18/iOS 10 获得访问系统 camera、照片库、麦克风、日历等 权限问题/">iOS 10 获得访问系统 camera、照片库、</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2016/11/16/Code=3000 _未找到应用程序的“aps-environment”的授权字符串_ 解决办法/">Code=3000 &quot;未找到应用程序的“aps-e</a>
            </li>
            
        </ul>
    </div>



            
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/klugjo/hexo-theme-alpha-dust">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://twitter.com/?lang=en">
                            <span class="footer-icon-container">
                                <i class="fa fa-twitter"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.facebook.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-facebook"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.instagram.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-instagram"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://dribbble.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-dribbble"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://plus.google.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-google-plus"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.behance.net/">
                            <span class="footer-icon-container">
                                <i class="fa fa-behance"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://500px.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-500px"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:test@example.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="\#">
                            <span class="footer-icon-container">
                                <i class="fa fa-rss"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @Untitled. All right reserved | Design & Hexo <a href="http://www.codeblocq.com/">Jonathan Klughertz</a>
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->



</body>

</html>